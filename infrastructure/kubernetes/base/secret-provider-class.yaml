# Azure Key Vault Secret Provider Class
# This configuration enables the Secrets Store CSI Driver to
# fetch secrets from Azure Key Vault and mount them as files/env vars.
#
# Prerequisites:
# 1. Azure Key Vault with secrets
# 2. AKS cluster with managed identity
# 3. Secrets Store CSI Driver installed
# 4. Azure Key Vault Provider for Secrets Store CSI Driver installed
#
# Install CSI driver:
#   az aks enable-addons --addons azure-keyvault-secrets-provider --name <cluster> --resource-group <rg>

apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: azure-keyvault-secrets
  namespace: smart-irrigation
spec:
  provider: azure
  parameters:
    usePodIdentity: "false"
    useVMManagedIdentity: "true"
    userAssignedIdentityID: "${AZURE_USER_ASSIGNED_IDENTITY_ID}"
    keyvaultName: "${AZURE_KEYVAULT_NAME}"
    tenantId: "${AZURE_TENANT_ID}"
    objects: |
      array:
        - |
          objectName: database-postgres-password
          objectType: secret
          objectAlias: POSTGRES_PASSWORD
        - |
          objectName: jwt-secret-key
          objectType: secret
          objectAlias: JWT_SECRET_KEY
        - |
          objectName: redis-password
          objectType: secret
          objectAlias: REDIS_PASSWORD
        - |
          objectName: influxdb-token
          objectType: secret
          objectAlias: INFLUXDB_TOKEN
        - |
          objectName: grafana-admin-password
          objectType: secret
          objectAlias: GRAFANA_ADMIN_PASSWORD
        - |
          objectName: mqtt-username
          objectType: secret
          objectAlias: MQTT_USERNAME
        - |
          objectName: mqtt-password
          objectType: secret
          objectAlias: MQTT_PASSWORD
  # Sync to Kubernetes Secrets for use as environment variables
  secretObjects:
    - secretName: database-secrets-synced
      type: Opaque
      data:
        - objectName: POSTGRES_PASSWORD
          key: POSTGRES_PASSWORD
    - secretName: auth-secrets-synced
      type: Opaque
      data:
        - objectName: JWT_SECRET_KEY
          key: JWT_SECRET_KEY
    - secretName: redis-secrets-synced
      type: Opaque
      data:
        - objectName: REDIS_PASSWORD
          key: REDIS_PASSWORD
    - secretName: influxdb-secrets-synced
      type: Opaque
      data:
        - objectName: INFLUXDB_TOKEN
          key: INFLUXDB_TOKEN

---
# Example usage in a deployment:
# 
# spec:
#   containers:
#     - name: my-container
#       volumeMounts:
#         - name: secrets-store
#           mountPath: "/mnt/secrets"
#           readOnly: true
#       env:
#         - name: POSTGRES_PASSWORD
#           valueFrom:
#             secretKeyRef:
#               name: database-secrets-synced
#               key: POSTGRES_PASSWORD
#   volumes:
#     - name: secrets-store
#       csi:
#         driver: secrets-store.csi.k8s.io
#         readOnly: true
#         volumeAttributes:
#           secretProviderClass: azure-keyvault-secrets
