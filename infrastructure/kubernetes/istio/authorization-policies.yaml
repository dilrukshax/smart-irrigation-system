# Istio Authorization Policies for Smart Irrigation System
#
# These policies implement zero-trust security:
# - Service-to-service authentication
# - Path-based authorization
# - JWT validation for API endpoints

apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: deny-all
  namespace: smart-irrigation
spec:
  # Default deny all traffic
  {}

---
# Allow traffic to web frontend (public)
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: allow-web
  namespace: smart-irrigation
spec:
  selector:
    matchLabels:
      app: web
  action: ALLOW
  rules:
    - from:
        - source:
            principals: ["cluster.local/ns/istio-system/sa/istio-ingressgateway-service-account"]
    - from:
        - source:
            namespaces: ["smart-irrigation"]

---
# Allow traffic to auth service (for login/register)
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: allow-auth-service
  namespace: smart-irrigation
spec:
  selector:
    matchLabels:
      app: auth-service
  action: ALLOW
  rules:
    # Public endpoints (login, register)
    - to:
        - operation:
            paths: ["/api/v1/auth/login", "/api/v1/auth/register", "/api/v1/auth/refresh", "/health", "/ready"]
      from:
        - source:
            principals: ["cluster.local/ns/istio-system/sa/istio-ingressgateway-service-account"]
    # Internal service-to-service
    - from:
        - source:
            namespaces: ["smart-irrigation"]

---
# Allow traffic to irrigation service (authenticated)
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: allow-irrigation-service
  namespace: smart-irrigation
spec:
  selector:
    matchLabels:
      app: irrigation-service
  action: ALLOW
  rules:
    # Health checks
    - to:
        - operation:
            paths: ["/health", "/ready"]
    # Internal service-to-service
    - from:
        - source:
            namespaces: ["smart-irrigation"]

---
# Allow traffic to forecasting service (authenticated)
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: allow-forecasting-service
  namespace: smart-irrigation
spec:
  selector:
    matchLabels:
      app: forecasting-service
  action: ALLOW
  rules:
    # Health checks
    - to:
        - operation:
            paths: ["/health", "/ready"]
    # Internal service-to-service
    - from:
        - source:
            namespaces: ["smart-irrigation"]

---
# Allow traffic to optimization service (authenticated)
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: allow-optimization-service
  namespace: smart-irrigation
spec:
  selector:
    matchLabels:
      app: optimization-service
  action: ALLOW
  rules:
    # Health checks
    - to:
        - operation:
            paths: ["/health", "/ready"]
    # Internal service-to-service
    - from:
        - source:
            namespaces: ["smart-irrigation"]

---
# Allow traffic to gateway (from ingress)
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: allow-gateway
  namespace: smart-irrigation
spec:
  selector:
    matchLabels:
      app: gateway
  action: ALLOW
  rules:
    - from:
        - source:
            principals: ["cluster.local/ns/istio-system/sa/istio-ingressgateway-service-account"]
    - from:
        - source:
            namespaces: ["smart-irrigation"]

---
# PeerAuthentication - Enable mutual TLS
apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: default
  namespace: smart-irrigation
spec:
  mtls:
    mode: STRICT

---
# RequestAuthentication - JWT validation
apiVersion: security.istio.io/v1beta1
kind: RequestAuthentication
metadata:
  name: jwt-auth
  namespace: smart-irrigation
spec:
  selector:
    matchLabels:
      app: gateway
  jwtRules:
    - issuer: "smart-irrigation-auth"
      # In production, use JWKS endpoint from auth service
      jwksUri: "http://auth-service:8001/.well-known/jwks.json"
      forwardOriginalToken: true
      outputPayloadToHeader: "x-jwt-payload"
